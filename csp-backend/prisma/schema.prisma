datasource db {
  url      = env("DATABASE_URL")
  provider = "mongodb"
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id    String @id @default(auto()) @map("_id") @db.ObjectId
  phoneNumber     String 
  phoneExtension  String   @default("+91")
  name            String? 
  email           String? 
  avatar          String?
  jwt             String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?
}

model Conversation {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  usertype        UserType
  userId          String
  text            String
  previouscontext String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model AIAgent {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  description     String?
  avatar          String?
  systemPrompt    String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?
  emailConversations EmailConversation[]
}

model EmailConversation {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  userId          String
  agentId         String
  agent           AIAgent  @relation(fields: [agentId], references: [id])
  subject         String?
  messages        EmailMessage[]
  voiceExchanges  VoiceExchange[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?
}

model EmailMessage {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  conversationId  String
  conversation    EmailConversation @relation(fields: [conversationId], references: [id])
  senderType      MessageSenderType
  content         String
  isRead          Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

enum UserType {
  agent
  user
}

enum MessageSenderType {
  user
  agent
}

model VoiceExchange {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  conversationId  String
  conversation    EmailConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userAudioUrl    String?  // URL to stored user audio file
  userTranscript  String?  // Transcribed text from user audio (from Gemini)
  agentResponse   String   // Agent's text response (from Gemini)
  agentAudioUrl   String?  // URL to generated agent audio (from Kokoro/Replicate)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}